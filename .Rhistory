if(OSys == "Linux"){ root <- "/mnt/workspace_cluster_9" } else {
if(OSys == "Windows"){ root <- "//dapadfs/Workspace_cluster_9" }
}; rm(OSys)
base <- raster::stack("//dapadfs/data_cluster_5/cropdata/agmerra/daily/nc-files/srad_daily_ts_agmerra_1980_2010.nc")
base <- base[[1]]
base <- rotate(base)
countries <- rgdal::readOGR(dsn = paste0(root, "/CWR_pre-breeding/Input_data/world_shape"), "all_countries")
countries$COUNTRY <- iconv(countries$COUNTRY, from = "UTF-8", to = "latin1")
countries[countries@data$COUNTRY=="Colombia",]
View(countries@data)
countries[countries@data$COUNTRY=="Colombia" & countries@data$UNREG1 == "Central America" & countries@data$UNREG1 == "Caribbean",]
central_america_colombia <- countries[countries@data$COUNTRY=="Colombia" & countries@data$UNREG1 == "Central America" & countries@data$UNREG1 == "Caribbean",]
plot(central_america_colombia)
central_america_colombia
central_america_colombia@data
central_america_colombia <- countries[countries@data$COUNTRY == "Colombia" & countries@data$UNREG1 == "Central America" | countries@data$UNREG1 == "Caribbean",]
plot(central_america_colombia)
central_america_colombia <- countries[countries@data$COUNTRY == "Colombia" & (countries@data$UNREG1 == "Central America" | countries@data$UNREG1 == "Caribbean"),]
central_america_colombia <- countries[countries@data$COUNTRY == "Colombia" & countries@data$UNREG1 == "Central America",]
central_america_colombia <- countries[countries@data$COUNTRY == "Colombia" | countries@data$UNREG1 == "Central America",]
plot(central_america_colombia)
central_america_colombia <- countries[countries@data$COUNTRY == "Colombia" | countries@data$UNREG1 == "Central America" | countries@data$UNREG1 == "Caribbean",]
plot(central_america_colombia)
extent(central_america_colombia)
prec <- readRDS("D:/prec_CACol.rds")
prec[1:5,(ncol(prec)-5):ncol(prec)]
prec$bean_coordinates <- NULL
# Planting dates
planting_rf_ggcmi <- raster::brick(paste("//dapadfs/Workspace_cluster_9/CWR_pre-breeding/Input_data/GGCMI-data/Pulses_rf_growing_season_dates_v1.25.nc4", sep = ""), varname = "planting day")
planting_rf_ggcmi <- planting_rf_ggcmi[[1]]
# Harversting dates
harvest_rf_ggcmi <- raster::brick(paste("//dapadfs/Workspace_cluster_9/CWR_pre-breeding/Input_data/GGCMI-data/Pulses_rf_growing_season_dates_v1.25.nc4", sep = ""), varname = "harvest day")
harvest_rf_ggcmi <- harvest_rf_ggcmi[[1]]
prec$Planting <- raster::extract(x = planting_rf_ggcmi, y = prec[,c("lon", "lat")])
prec$Harvest  <- raster::extract(x = harvest_rf_ggcmi, y = prec[,c("lon", "lat")])
prec[1:5,(ncol(prec)-5):ncol(prec)]
prec$Duration <- ifelse(test = prec$Planting < prec$Harvest, yes = "One year", no = "Two years")
prec[1:5,(ncol(prec)-5):ncol(prec)]
hist(prec$Planting)
hist(prec$Harvest)
summary(prec$Planting)
summary(prec$Harvest)
table(prec$Duration)
prec[1:5,(ncol(prec)-5):ncol(prec)]
1:(ncol(prec) - 3)
(ncol(prec) - 3)
time.serie <- prec[i, 1:(ncol(prec)-3)]
i=1
duration <- prec$Duration[i]
start <- prec$Planting[i]
end <- prec$Harvest[i]
duration
start
end
time.serie <- prec[i, 1:(ncol(prec)-3)]
View(time.serie)
time.serie
time.serie[,1:5]
X <- time.serie
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
View(X)
X$Year <- lubridate::year(as.Date(X$Date))
X$Yday <- lubridate::yday(as.Date(X$Date))
View(X)
X <- X %>% group_by(Year) %>% dplyr::filter(Yday >= start & Yday <= end)
View(X)
totrain <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(TOTRAIN = sum(Value))
totrain
totrain %>% ggplot() + theme_tufte() + geom_line(aes(x = Year, y = TOTRAIN)) + scale_x_continuous(breaks = 1981:2010) + theme(axis.text.x = element_text(angle = 45))
totrain %>% ggplot() + theme_bw() + geom_line(aes(x = Year, y = TOTRAIN)) + scale_x_continuous(breaks = 1981:2010) + theme(axis.text.x = element_text(angle = 45))
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
suppressMessages(if(!require(compiler)){install.packages('compiler'); library(compiler)} else {library(compiler)})
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
plot(cdd)
plot(cdd, ty = "l")
run_avg <- function(x){
z <- caTools::runmean(x, k = 5, endrule = 'NA')
z <- max(z, na.rm = TRUE)
return(z)
}
p5d <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P5D = run_avg(x = Value))
plot(p5d, ty = "l")
p_95 <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P_95 = quantile(Value, probs = .95, na.rm = TRUE))
plot(p_95, ty = "l")
calculations <- function(time.serie, start, end){
X <- time.serie
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
X$Year <- lubridate::year(as.Date(X$Date))
X$Yday <- lubridate::yday(as.Date(X$Date))
X <- X %>% group_by(Year) %>% dplyr::filter(Yday >= start & Yday <= end)
# Total precipitation
totrain <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(TOTRAIN = sum(Value))
# Drought spell: Maximum number of consecutive dry days (i.e. with precipitation < 1 mm day-1)
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
# Flooding: Maximum 5-day running average precipitation
run_avg <- function(x){
z <- caTools::runmean(x, k = 5, endrule = 'NA')
z <- max(z, na.rm = TRUE)
return(z)
}
p5d <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P5D = run_avg(x = Value))
# Erosion risk: 95th percentile of daily precipitation
p_95 <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P_95 = quantile(Value, probs = .95, na.rm = TRUE))
return(list(totrain = totrain, cdd = cdd, p5d = p5d, p_95 = p_95))
}
results <- calculations(time.serie = time.serie, start = start, end = end)
results
totrain
totrain <- totrain %>% as.data.frame
totrain
rbind(totrain, cdd, p5d, p_95)
totrain <- totrain %>% as.data.frame
names(totrain)[2] <- "Value"; totrain$Variable <- "TOTRAIN"
cdd <- cdd %>% as.data.frame
names(cdd)[2] <- "Value"; cdd$Variable <- "CDD"
p5d <- p5d %>% as.data.frame
names(p5d)[2] <- "Value"; p5d$Variable <- "P5D"
p_95 <- p_95 %>% as.data.frame
names(p_95)[2] <- "Value"; p_95$Variable <- "P_95"
rbind(totrain, cdd, p5d, p_95)
TEST <- lapply(1:nrow(prec), function(i){
duration <- prec$Duration[i]
start <- prec$Planting[i]
end <- prec$Harvest[i]
time.serie <- prec[i, 1:(ncol(prec)-3)]
if(duration == "One year"){
calculations <- function(time.serie, start, end){
X <- time.serie
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
X$Year <- lubridate::year(as.Date(X$Date))
X$Yday <- lubridate::yday(as.Date(X$Date))
X <- X %>% group_by(Year) %>% dplyr::filter(Yday >= start & Yday <= end)
# Total precipitation
totrain <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(TOTRAIN = sum(Value))
totrain <- totrain %>% as.data.frame
names(totrain)[2] <- "Value"; totrain$Variable <- "TOTRAIN"
# Drought spell: Maximum number of consecutive dry days (i.e. with precipitation < 1 mm day-1)
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
cdd <- cdd %>% as.data.frame
names(cdd)[2] <- "Value"; cdd$Variable <- "CDD"
# Flooding: Maximum 5-day running average precipitation
run_avg <- function(x){
z <- caTools::runmean(x, k = 5, endrule = 'NA')
z <- max(z, na.rm = TRUE)
return(z)
}
p5d <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P5D = run_avg(x = Value))
p5d <- p5d %>% as.data.frame
names(p5d)[2] <- "Value"; p5d$Variable <- "P5D"
# Erosion risk: 95th percentile of daily precipitation
p_95 <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P_95 = quantile(Value, probs = .95, na.rm = TRUE))
p_95 <- p_95 %>% as.data.frame
names(p_95)[2] <- "Value"; p_95$Variable <- "P_95"
return(rbind(totrain, cdd, p5d, p_95))
}
results <- calculations(time.serie = time.serie, start = start, end = end)
}
return(results)
})
TEST <- lapply(1:nrow(prec), function(i){
duration <- prec$Duration[i]
start <- prec$Planting[i]
end <- prec$Harvest[i]
time.serie <- prec[i, 1:(ncol(prec)-3)]
if(duration == "One year"){
calculations <- function(time.serie, start, end){
X <- time.serie
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
X$Year <- lubridate::year(as.Date(X$Date))
X$Yday <- lubridate::yday(as.Date(X$Date))
X <- X %>% group_by(Year) %>% dplyr::filter(Yday >= start & Yday <= end)
# Total precipitation
totrain <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(TOTRAIN = sum(Value))
totrain <- totrain %>% as.data.frame
names(totrain)[2] <- "Value"; totrain$Variable <- "TOTRAIN"
# Drought spell: Maximum number of consecutive dry days (i.e. with precipitation < 1 mm day-1)
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
cdd <- cdd %>% as.data.frame
names(cdd)[2] <- "Value"; cdd$Variable <- "CDD"
# Flooding: Maximum 5-day running average precipitation
run_avg <- function(x){
z <- caTools::runmean(x, k = 5, endrule = 'NA')
z <- max(z, na.rm = TRUE)
return(z)
}
p5d <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P5D = run_avg(x = Value))
p5d <- p5d %>% as.data.frame
names(p5d)[2] <- "Value"; p5d$Variable <- "P5D"
# Erosion risk: 95th percentile of daily precipitation
p_95 <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P_95 = quantile(Value, probs = .95, na.rm = TRUE))
p_95 <- p_95 %>% as.data.frame
names(p_95)[2] <- "Value"; p_95$Variable <- "P_95"
return(data.frame(cellID = unique(X$cellID), rbind(totrain, cdd, p5d, p_95)))
}
results <- calculations(time.serie = time.serie, start = start, end = end)
}
return(results)
})
saveRDS(object = prec, file = "D:/precipitation.rds")
plot(prec[,c("lon", "lat")], pch = 20)
prec <- readRDS("D:/precipitation.rds")
plot(prec[,c("lon", "lat")])
View(prec)
prec[1:5,(ncol(prec)-5):ncol(prec)]
table(prec$Duration)
i=1
duration <- prec$Duration[i]
start <- prec$Planting[i]
end <- prec$Harvest[i]
duration
start
end
time.serie <- prec[i, 1:(ncol(prec)-3)]
time.serie
time.serie[,1:5]
X <- time.serie
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
library(tidyverse)
X <- X %>% gather(key = Date, value = Value, -(cellID:lat))
View(X)
X$Year <- lubridate::year(as.Date(X$Date))
X$Yday <- lubridate::yday(as.Date(X$Date))
X <- X %>% group_by(Year) %>% dplyr::filter(Yday >= start & Yday <= end)
totrain <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(TOTRAIN = sum(Value))
totrain <- totrain %>% as.data.frame
totrain
plot(totrain, ty = 'l')
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
cdd <- cdd %>% as.data.frame
library(compiler)
dr_stress <- function(PREC, p_thresh = 1){
runs <- rle(PREC < p_thresh)
cons_days <- max(runs$lengths[runs$values==1], na.rm=TRUE)
return(cons_days)
}
dr_stressCMP <- cmpfun(dr_stress); rm(dr_stress)
cdd <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(CDD = dr_stressCMP(Value, p_thresh = 1))
cdd <- cdd %>% as.data.frame
plot(cd, ty = 'l')
plot(cdd, ty = 'l')
run_avg <- function(x){
z <- caTools::runmean(x, k = 5, endrule = 'NA')
z <- max(z, na.rm = TRUE)
return(z)
}
p5d <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P5D = run_avg(x = Value))
p5d <- p5d %>% as.data.frame
plot(p5d, ty = 'l')
p_95 <- X %>% dplyr::group_by(Year) %>% dplyr::arrange(Date) %>% summarise(P_95 = quantile(Value, probs = .95, na.rm = TRUE))
p_95 <- p_95 %>% as.data.frame
names(p_95)[2] <- "Value"; p_95$Variable <- "P_95"
plot(p_95, ty = "l")
View(p_95)
plot(p_95[,1:2], ty = "l")
table(prec$Duration)
table(prec$Duration)/4590
table(prec$Duration)/4931
View(prec)
View(prec[prec$Duration == "Two years",])
-9.987535e-01
-9.987535e-02
-9.987535e-02
5.752047e+00
-9.987535e-02
-4.069580e-01
-2.896928e+00
suppressMessages(if(!require(raster)){install.packages('raster'); library(raster)} else {library(raster)})
suppressMessages(if(!require(ncdf4)){install.packages('ncdf4'); library(ncdf4)} else {library(ncdf4)})
suppressMessages(if(!require(maptools)){install.packages('maptools'); library(maptools)} else {library(maptools)})
suppressMessages(if(!require(ff)){install.packages('ff'); library(ff)} else {library(ff)})
suppressMessages(if(!require(data.table)){install.packages('data.table'); library(data.table)} else {library(data.table)})
suppressMessages(if(!require(miscTools)){install.packages('miscTools'); library(miscTools)} else {library(miscTools)})
suppressMessages(if(!require(rgdal)){install.packages('rgdal'); library(rgdal)} else {library(rgdal)})
suppressMessages(if(!require(foreach)){install.packages('foreach'); library(foreach)} else {library(foreach)})
suppressMessages(if(!require(mgcv)){install.packages('mgcv'); library(mgcv)} else {library(mgcv)})
suppressMessages(if(!require(rasterVis)){install.packages('rasterVis'); library(rasterVis)} else {library(rasterVis)})
suppressMessages(if(!require(stringr)){install.packages('stringr'); library(stringr)} else {library(stringr)})
suppressMessages(if(!require(tidyverse)){install.packages('tidyverse'); library(tidyverse)} else {library(tidyverse)})
suppressMessages(if(!require(mapdata)){install.packages('mapdata'); library(mapdata)} else {library(mapdata)})
suppressMessages(if(!require(FactoMineR)){install.packages('FactoMineR'); library(FactoMineR)} else {library(FactoMineR)})
suppressMessages(if(!require(FactoClass)){install.packages('FactoClass'); library(FactoClass)} else {library(FactoClass)})
suppressMessages(if(!require(ade4)){install.packages('ade4'); library(ade4)} else {library(ade4)})
suppressMessages(if(!require(xtable)){install.packages('xtable'); library(xtable)} else {library(xtable)})
suppressMessages(if(!require(ggdendro)){install.packages('ggdendro'); library(ggdendro)} else {library(ggdendro)})
suppressMessages(if(!require(compiler)){install.packages('compiler'); library(compiler)} else {library(compiler)})
suppressMessages(if(!require(ggthemes)){install.packages('ggthemes'); library(ggthemes)} else {library(ggthemes)})
suppressMessages(if(!require(dtwclust)){install.packages('dtwclust'); library(dtwclust)} else {library(dtwclust)})
suppressMessages(if(!require(cluster)){install.packages('cluster'); library(cluster)} else {library(cluster)})
OSys <- Sys.info(); OSys <- OSys[names(OSys)=="sysname"]
if(OSys == "Linux"){
root <- "/mnt/workspace_cluster_9"
base <- readRDS(paste0(root, "/CWR_pre-breeding/Input_data/AgMerra_template.RDS"))
} else {
if(OSys == "Windows"){
root <- "//dapadfs/Workspace_cluster_9"
base <- readRDS(paste0(root, "/CWR_pre-breeding/Input_data/AgMerra_template.RDS"))
}
}; rm(OSys)
plot(base)
2010-1981
?save
load("//dapadfs/workspace_cluster_8/Kenya_KACCAL/data/bc_quantile_0_05deg_lat/bcc_csm1_1/2021_2045/rcp60/Machakos/tmax/bc_qmap_tmax_2021_2045.RData")
dim(gcmFutBC)
suppressMessages(library(tidyverse))
final.coordinates <- read.csv("~/KenyaMatrixCrop_rainfed.csv", row.names = 1)
final.coordinates <- read.csv("~/KenyaMatrixCrop_rainfed.csv")
View(final.coordinates)
soil.coordinates <- read.table(file = "//dapadfs/workspace_cluster_3/bid-cc-agricultural-sector/02-Soil-data/data_hc3ksol_5m_global.txt", header = T)
soil.coordinates <- soil.coordinates %>% dplyr::group_by(CELL5M) %>% dplyr::arrange(-SharePct)
soil.raster <- raster::raster("//dapadfs/workspace_cluster_3/bid-cc-agricultural-sector/02-Soil-data/cell5m.asc")
cellID <- raster::cellFromXY(object = soil.raster, xy = final.coordinates)
cellID <- raster::cellFromXY(object = soil.raster, xy = final.coordinates[,c("x", "y")])
soil.coordinates.filtered <- soil.coordinates[na.omit(match(cellID, soil.coordinates$CELL5M)),]; rownames(soil.coordinates.filtered) <- 1:nrow(soil.coordinates.filtered)
names(soil.coordinates.filtered)[1] <- "CELL30M"
rm(cellID, soil.raster)
View(soil.coordinates.filtered)
length(unique(soil.coordinates.filtered$CELL30M))
View(soil.coordinates.filtered)
sourceCpp("fastPdist.cpp") # Pairwise Euclidean distance function in C++
suppressMessages(if(!require(raster)){install.packages('raster'); library(raster)} else {library(raster)})
suppressMessages(if(!require(ncdf4)){install.packages('ncdf4'); library(ncdf4)} else {library(ncdf4)})
suppressMessages(if(!require(maptools)){install.packages('maptools'); library(maptools)} else {library(maptools)})
suppressMessages(if(!require(ff)){install.packages('ff'); library(ff)} else {library(ff)})
suppressMessages(if(!require(data.table)){install.packages('data.table'); library(data.table)} else {library(data.table)})
suppressMessages(if(!require(miscTools)){install.packages('miscTools'); library(miscTools)} else {library(miscTools)})
suppressMessages(if(!require(rgdal)){install.packages('rgdal'); library(rgdal)} else {library(rgdal)})
suppressMessages(if(!require(foreach)){install.packages('foreach'); library(foreach)} else {library(foreach)})
suppressMessages(if(!require(mgcv)){install.packages('mgcv'); library(mgcv)} else {library(mgcv)})
suppressMessages(if(!require(rasterVis)){install.packages('rasterVis'); library(rasterVis)} else {library(rasterVis)})
suppressMessages(if(!require(stringr)){install.packages('stringr'); library(stringr)} else {library(stringr)})
suppressMessages(if(!require(tidyverse)){install.packages('tidyverse'); library(tidyverse)} else {library(tidyverse)})
suppressMessages(if(!require(mapdata)){install.packages('mapdata'); library(mapdata)} else {library(mapdata)})
suppressMessages(if(!require(FactoMineR)){install.packages('FactoMineR'); library(FactoMineR)} else {library(FactoMineR)})
suppressMessages(if(!require(FactoClass)){install.packages('FactoClass'); library(FactoClass)} else {library(FactoClass)})
suppressMessages(if(!require(ade4)){install.packages('ade4'); library(ade4)} else {library(ade4)})
suppressMessages(if(!require(xtable)){install.packages('xtable'); library(xtable)} else {library(xtable)})
suppressMessages(if(!require(ggdendro)){install.packages('ggdendro'); library(ggdendro)} else {library(ggdendro)})
suppressMessages(if(!require(compiler)){install.packages('compiler'); library(compiler)} else {library(compiler)})
suppressMessages(if(!require(ggthemes)){install.packages('ggthemes'); library(ggthemes)} else {library(ggthemes)})
suppressMessages(if(!require(dtwclust)){install.packages('dtwclust'); library(dtwclust)} else {library(dtwclust)})
suppressMessages(if(!require(cluster)){install.packages('cluster'); library(cluster)} else {library(cluster)})
sourceCpp("fastPdist.cpp") # Pairwise Euclidean distance function in C++
library(Rcpp)
library(RcppArmadillo)
sourceCpp("fastPdist.cpp") # Pairwise Euclidean distance function in C++
library("RcppEigen", lib.loc="~/R/win-library/3.4")
library("RcppRoll", lib.loc="~/R/win-library/3.4")
library("bindrcpp", lib.loc="~/R/win-library/3.4")
sourceCpp("fastPdist.cpp") # Pairwise Euclidean distance function in C++
library(feather)
install.packages("feather")
library("feather", lib.loc="~/R/win-library/3.4")
?over
?saveRDS
source('//dapadfs/workspace_cluster_8/Kenya_KACCAL/scripts/KACCAL_calc_risk_indices_modified.R')
options(warn = -1); options(scipen = 999)
suppressMessages(library(raster))
suppressMessages(library(ncdf))
suppressMessages(library(ncdf4))
suppressMessages(library(maptools))
suppressMessages(library(ff))
suppressMessages(library(data.table))
suppressMessages(library(miscTools))
suppressMessages(library(compiler))
countyList <- data.frame(Cluster=c(rep('Cluster 1', 8),
rep('Cluster 2', 8)),
County=c('Bomet', 'Kericho', 'Kakamega', 'Uasin Gishu', 'Keiyo-Marakwet', 'Machakos', 'Kisumu', 'Kajiado',
'Baringo', 'Laikipia', 'Tharaka', 'Lamu', 'Marsabit', 'Isiolo', 'Wajir', 'Mandera'))
countyList$Cluster <- as.character(countyList$Cluster)
countyList$County <- as.character(countyList$County)
countyList <- countyList[1,]
countyList
county='Bomet', season='first'
county='Bomet'; season='first'
cat('\n\n\n*** Processing:', gsub(pattern=' ', replacement='_', county, fixed=TRUE), 'county ***\n\n')
countyDir <- paste(inputDir, '/', gsub(pattern=' ', replacement='_', county, fixed=TRUE), sep='')
inputDir <- '//dapadfs/workspace_cluster_12/Kenya_KACCAL/data/input_tables'
outputDir <- '//dapadfs/workspace_cluster_12/Kenya_KACCAL/results/climatic_indices/historical'
seasonList <- c('first', 'second')
cat('\n\n\n*** Processing:', gsub(pattern=' ', replacement='_', county, fixed=TRUE), 'county ***\n\n')
countyDir <- paste(inputDir, '/', gsub(pattern=' ', replacement='_', county, fixed=TRUE), sep='')
dir.exists(countyDir)
indexes <- paste(outputDir, '/', season, '_season/', gsub(pattern=' ', replacement='_', county, fixed=TRUE), '_', season, '_season_2015.RData', sep='')
indexes
cat('Loading raster mask for:', gsub(pattern=' ', replacement='_', county), '\n')
countyMask <- raster(paste("//dapadfs/workspace_cluster_12/Kenya_KACCAL/data/Kenya_counties_rst/", gsub(pattern=' ', replacement='_', county), "_base.tif", sep=""))
cat('Loading: Solar radiation for first wet season\n')
if(season == 'first'){
load(paste(countyDir, '/dswrf/dswrf_fs_wet_days.RData', sep=''))
dswrf <- first_season_var; rm(first_season_var)
} else {
if(season == 'second'){
load(paste(countyDir, '/dswrf/dswrf_ss_wet_days.RData', sep=''))
dswrf <- second_season_var; rm(second_season_var)
}
}
dswrf <- dswrf[years_analysis]
dswrf <- lapply(1:length(dswrf), function(i){z <- as.data.frame(dswrf[[i]]); yr <- as.numeric(gsub(pattern='y', replacement='', x=names(dswrf)[i])); names(z)[4:length(names(z))] <- as.character(seq(as.Date(paste(yr, '-01-01', sep='')), as.Date(paste(yr, '-12-31', sep='')), by=1)); return(z)})
names(dswrf) <- years_analysis
dswrf <- reshape::merge_recurse(dswrf)
years_analysis <- paste('y', 1981:2005, sep='')
if(season == 'first'){
load(paste(countyDir, '/dswrf/dswrf_fs_wet_days.RData', sep=''))
dswrf <- first_season_var; rm(first_season_var)
} else {
if(season == 'second'){
load(paste(countyDir, '/dswrf/dswrf_ss_wet_days.RData', sep=''))
dswrf <- second_season_var; rm(second_season_var)
}
}
dswrf <- dswrf[years_analysis]
dswrf <- lapply(1:length(dswrf), function(i){z <- as.data.frame(dswrf[[i]]); yr <- as.numeric(gsub(pattern='y', replacement='', x=names(dswrf)[i])); names(z)[4:length(names(z))] <- as.character(seq(as.Date(paste(yr, '-01-01', sep='')), as.Date(paste(yr, '-12-31', sep='')), by=1)); return(z)})
names(dswrf) <- years_analysis
dswrf <- reshape::merge_recurse(dswrf)
if(season == 'first'){
load(paste(countyDir, '/prec/prec_fs_wet_days.RData', sep=''))
prec <- chirps_wet_days; rm(chirps_wet_days)
} else {
if(season == 'second'){
load(paste(countyDir, '/prec/prec_ss_wet_days.RData', sep=''))
prec <- chirps_wet_days; rm(chirps_wet_days)
}
}
years_prec <- gsub(pattern='y', replacement='', names(prec))
# prec <- prec[years_analysis]
prec <- lapply(1:length(prec), function(i){z <- as.data.frame(prec[[i]]); yr <- as.numeric(gsub(pattern='y', replacement='', x=names(prec)[i])); names(z)[4:length(names(z))] <- as.character(seq(as.Date(paste(yr, '-01-01', sep='')), as.Date(paste(yr, '-12-31', sep='')), by=1)); return(z)})
names(prec) <- years_analysis
prec <- reshape::merge_recurse(prec)
load(paste(countyDir, '/soil/soil_data.RData', sep=''))
soil <- soil_data_county; rm(soil_data_county)
soil <- soil[,c("cellID","lon.x","lat.x","id_coarse","rdepth","d.25","d.100","d.225","d.450","d.800","d.1500","soilcp")]
names(soil)[2:3] <- c('lon','lat')
View(soil)
library(ggplot2)
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw()
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_colour_gradientn(colours = terrain.colors(10))
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = terrain.colors(10))
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = viridis)
library(viridisLite)
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = viridis)
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = "viridis")
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = viridis())
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = vir)
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = "vir")
ggplot(data = soil, aes(x = lon, y = lat, fill = soilcp)) +
geom_raster() +
coord_equal() +
theme_bw() + scale_fill_gradientn(colours = inferno(256))
library("GSIF", lib.loc="~/R/win-library/3.4")
demo("GSIF")
